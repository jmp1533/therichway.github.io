name: AI Blog Daily Report

on:
  schedule:
    # 한국 시간 기준 월~토 오전 8시 (UTC 23시)
    - cron: '0 23 * * 0-5'
  repository_dispatch:
    types: [generate_post, publish_post]
  workflow_dispatch:

jobs:
  run_automation:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # [랜덤 지연] 스케줄 실행일 때만 0~30분(1800초) 랜덤 대기
      # 8시(UTC 23시)에 시작해서 최대 8시 30분까지 분산 실행됨
      - name: Random Delay
        if: github.event_name == 'schedule'
        run: |
          DELAY=$((RANDOM % 1801)) # 0초부터 1800초(30분)까지
          echo "Sleeping for $DELAY seconds..."
          sleep $DELAY

      # [단계 1] 포스팅 생성 로직
      - name: Create Post & Notify
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' || github.event.action == 'generate_post'
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          FOCUS_TOPIC: ${{ github.event.client_payload.focus_topic }}
        run: python scripts/generate_post.py

      # [단계 2] 발행 승인 로직 (필요 시 유지, 자동 발행으로 변경했으므로 사실상 불필요할 수 있음)
      - name: Publish if Approved
        if: github.event.action == 'publish_post'
        run: |
          latest_file=$(ls -r _posts/us-stock/*.md | head -1)
          
          if [ -z "$latest_file" ]; then
            echo "❌ 변경할 포스팅 파일이 없습니다."
            exit 1
          fi
          
          echo "Target File: $latest_file"
          sed -i 's/published: false/published: true/g' "$latest_file"

      # [단계 3] 변경사항 반영 (Git Push)
      - name: Push Changes
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add .
          git commit -m "Automated Blog Update [${{ github.event_name }}]" || exit 0
          git push